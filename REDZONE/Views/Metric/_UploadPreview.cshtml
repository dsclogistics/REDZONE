@model REDZONE.Models.RZ_Metric

<!-- jasny-bootstrap Latest compiled and minified CSS          Used for File Uploader Widget  -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jasny-bootstrap/3.1.3/css/jasny-bootstrap.min.css">
<!-- jasny-bootstrap Latest compiled and minified JavaScript   Used for File Uploader Widget  -->
<script src="//cdnjs.cloudflare.com/ajax/libs/jasny-bootstrap/3.1.3/js/jasny-bootstrap.min.js"></script>

<div class="modal-header" style="background-color: #e2e1e1">
    <button type="button" class="close" data-dismiss="modal">&times;</button>
    <h4 class="modal-title"> Excel Data File Import/Validation</h4>
</div>

<div class="modal-body">
    @*<div id="UploadSection" >

        </div>*@
    @*@using (Ajax.BeginForm("Upload", "Metric", new AjaxOptions { HttpMethod = "POST", InsertionMode = InsertionMode.Replace, UpdateTargetId = "validation-partial", OnSuccess = "postSuccess", OnFailure = "postFailed" }))*@
@using (Html.BeginForm("Upload", "Metric", FormMethod.Post, new { enctype = "multipart/form-data", id = "frmExcelUpload" }))
{
        <input type="hidden" name="metricId" value="@Model.id" />
        <input type="hidden" name="metricName" value="@Model.metricName" />
        <input type="hidden" name="metricMonth" value="@Model.displayPeriodName.Substring(0, @Model.displayPeriodName.IndexOf(' '))" />
        <input type="hidden" name="metricYear" value="@Model.displayPeriodName.Substring(@Model.displayPeriodName.IndexOf(' ') + 1)" />
        <input type="hidden" name="metricDataType" value="@Model.metricDataType" />
        <input type="hidden" id="allBuildings" value="@Model.allBuildings" name="allBuildings" />
        <input type="hidden" name="na_allowed" value="@Model.na_allowed.ToString()" />

        <div class="row">
            <div class="col-sm-6">
                <div class="fileinput fileinput-new input-group " data-provides="fileinput">
                    <div class="form-control" data-trigger="fileinput">
                        <i class="glyphicon glyphicon-file fileinput-exists"></i>
                        <span class="fileinput-filename"></span>
                    </div>
                    <span class="input-group-addon btn btn-primary btn-file">
                        <span class="fileinput-new ">Select file to Upload</span>
                        <span class="fileinput-exists">Change</span>
                        <input type="file" id="UploadedFile" name="UploadedFile" style="max-width: 300px">
                    </span>
                    <a href="#" class="input-group-addon btn btn-primary fileinput-exists" data-dismiss="fileinput">Remove</a>
                </div>
            </div>
            <div class="col-sm-4">
                <input class="btn btn-primary" type="submit" name="Submit" id="btnSubmit" value="Validate File" disabled="disabled" />
            </div>
            <div class="col-sm-2">
            </div>
        </div>
    }

    @*@using (Html.BeginForm("Upload", "Metric", FormMethod.Post, new { enctype = "multipart/form-data", id="frmExcelUpload" }))
    {
    }*@

    <br /><br />
    <div id="validation-partial">

    </div>
</div>

<div class="modal-footer" style="text-align:center">

        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button type="button" id="approve-btn" class="btn btn-danger">Upload</button>

</div>

<script>
    $(document).ready(function () {
        $("#UploadedFile").on('change', function () {
            if ($(this).val() == "") {
                $("#btnSubmit").prop("disabled", true);
            }
            else {
                var file = this.files[0];
                var name = file.name;
                var size = file.size;
                var type = file.type;
                if (file.name.match(/xlsx/) == null) {
                    $("#btnSubmit").prop("disabled", true);
                    alert("Invalid File Selected. File must be an Excel '*.xlsx' File");
                    $(this).val("");
                }
                else {
                    //alert("Selection done:\nFile Name: " + name + "\nFile Size: " + size + "\nFile Type: " + type);
                    $("#btnSubmit").prop("disabled", false);
                }
            }
        });

        $("#approve-btn").click(function () {
            
            var formData = new FormData($('#frmExcelUpload')[0]);
            var myFile = document.getElementById('UploadedFile').files[0];
            formData.append('UploadedFile', myFile, myFile.name);

            //$.ajax({
            //    type: "POST",
            //    url: "/Metric/Upload/",
            //    data: formData,
            //    success: function () {
            //        alert("Ajax call successful");
            //    },
            //    error: function () {
            //        alert("Ajax call Failed");
            //    }
            //});   

            // Set up the request.
            var xhr = new XMLHttpRequest();
            // Open the connection.
            xhr.open('POST', '/Metric/Upload', true);
            // Set up a handler for when the request finishes.
            xhr.onload = function (d) {
                if (xhr.status === 200) {
                    //// File(s) uploaded.
                    $('#approve-btn').html("Wait");
                    // uploadButton.innerHTML = 'Upload';
                    alert("Process Completed.\n" );
                } else {
                    alert('An error occurred!');
                }
            };
            // Send the Data.
            xhr.send(formData);
            

            @*$.ajax({
                url: '@Url.Action("Upload", "Metric")',
                method: "POST",
                cache: false,
                data: formData,
                error: function () {
                    obsAlert("Failed to run Ajax");  //<-- Trap and alert of any errors if they occurred
                }
            }).done(function (d) {
                alert("Done");
            });*@


        });

    }); //----- End Ready ------
    function postSuccess() {
        alert("Post was successful.");
    }
    function postFailed() {
        alert("Post Failed.");
    }

</script>